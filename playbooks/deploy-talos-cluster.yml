---
- name: Deploy Talos Linux cluster
  hosts: localhost
  gather_facts: yes
  vars:
    talos_config_dir: "{{ playbook_dir }}/../talos-configs"
    talos_secrets_file: "{{ talos_config_dir }}/secrets.yaml"
    talosconfig_file: "{{ talos_config_dir }}/talosconfig"
    kubeconfig_dest: "{{ ansible_env.HOME }}/.kube/config"
    apply_timeout: 600  # 10 minutes for config application
    health_check_timeout: 600  # 10 minutes per node for health checks
    etcd_ready_timeout: 600  # 10 minutes for etcd to become ready

  tasks:
    - name: Verify talos-configs directory exists
      stat:
        path: "{{ talos_config_dir }}"
      register: config_dir_stat
      failed_when: not config_dir_stat.stat.exists

    - name: Verify secrets file exists
      stat:
        path: "{{ talos_secrets_file }}"
      register: secrets_stat
      failed_when: not secrets_stat.stat.exists

    - name: Verify talosconfig exists
      stat:
        path: "{{ talosconfig_file }}"
      register: talosconfig_stat
      failed_when: not talosconfig_stat.stat.exists

    - name: Read dnsmasq leases file
      slurp:
        src: /var/lib/misc/dnsmasq.leases
      register: dnsmasq_leases_raw
      become: yes

    - name: Parse dnsmasq leases to get current IP assignments
      set_fact:
        dnsmasq_lease_map: >-
          {{
            dnsmasq_lease_map | default({}) |
            combine({
              item.split()[1] | lower: item.split()[2]
            })
          }}
      loop: "{{ (dnsmasq_leases_raw.content | b64decode).split('\n') }}"
      when: item | length > 0

    - name: Add current dynamic IPs to hosts
      set_fact:
        pxe_hosts_with_current_ip: >-
          {{
            pxe_hosts_with_current_ip | default([]) +
            [{
              'name': item.name,
              'mac': item.mac,
              'static_ip': item.ip,
              'current_ip': dnsmasq_lease_map[item.mac | lower] | default(item.ip),
              'role': item.role,
              'install_disk': item.install_disk
            } | combine(item)]
          }}
      loop: "{{ pxe_hosts }}"

    - name: Filter control plane and worker nodes
      set_fact:
        controlplane_hosts: "{{ pxe_hosts_with_current_ip | selectattr('role', 'equalto', 'controlplane') | list }}"
        worker_hosts: "{{ pxe_hosts_with_current_ip | selectattr('role', 'equalto', 'worker') | list }}"
        first_controlplane: "{{ (pxe_hosts_with_current_ip | selectattr('role', 'equalto', 'controlplane') | list)[0] }}"
        all_hosts: "{{ pxe_hosts_with_current_ip }}"

    - name: Display deployment plan
      debug:
        msg:
          - "========================================="
          - "Talos Cluster Deployment Plan"
          - "========================================="
          - "Control Plane Nodes: {{ controlplane_hosts | length }}"
          - "{% for host in controlplane_hosts %}  - {{ host.name }}\n    Current IP (PXE): {{ host.current_ip }}\n    Static IP (final): {{ host.static_ip }}\n{% endfor %}"
          - "Worker Nodes: {{ worker_hosts | length }}"
          - "{% for host in worker_hosts %}  - {{ host.name }}\n    Current IP (PXE): {{ host.current_ip }}\n    Static IP (final): {{ host.static_ip }}\n{% endfor %}"
          - "Bootstrap Node: {{ first_controlplane.name }}"
          - "  Current IP: {{ first_controlplane.current_ip }}"
          - "  Static IP: {{ first_controlplane.static_ip }}"
          - "========================================="
          - ""
          - "NOTE: Configs will be applied to current PXE IPs."
          - "After reboot, nodes will use their static IPs."
          - "========================================="

    - name: Pause for user confirmation
      pause:
        prompt: |

          This will apply Talos configurations to all nodes and bootstrap the cluster.
          Make sure all nodes have been PXE booted into Talos maintenance mode.

          Press ENTER to continue or Ctrl+C to abort...

    # Apply configurations to ALL nodes (control plane + workers)
    - name: Apply configuration to all nodes (insecure mode)
      command: >
        talosctl apply-config
        --insecure
        --nodes {{ host.current_ip }}
        --file {{ talos_config_dir }}/{{ host.name.split('.')[0] }}.yaml
      loop: "{{ all_hosts }}"
      loop_control:
        loop_var: host
      register: apply_all_insecure
      ignore_errors: yes
      async: "{{ apply_timeout }}"
      poll: 10

    - name: Apply configuration to already-configured nodes (authenticated mode)
      command: >
        talosctl apply-config
        --nodes {{ item.host.current_ip }}
        --endpoints {{ item.host.current_ip }}
        --file {{ talos_config_dir }}/{{ item.host.name.split('.')[0] }}.yaml
        --talosconfig {{ talosconfig_file }}
      loop: "{{ apply_all_insecure.results }}"
      when: item.rc != 0
      register: apply_all_auth
      ignore_errors: yes
      async: "{{ apply_timeout }}"
      poll: 10

    - name: Wait for initial configuration application to begin
      pause:
        seconds: 30
        prompt: "Waiting for nodes to begin applying configuration..."

    - name: Wait for control plane nodes to be healthy and ready
      command: >
        talosctl health
        --nodes {{ host.static_ip }}
        --endpoints {{ host.static_ip }}
        --talosconfig {{ talosconfig_file }}
        --wait-timeout 10m
      loop: "{{ controlplane_hosts }}"
      loop_control:
        loop_var: host
        label: "{{ host.name }} ({{ host.static_ip }})"
      register: controlplane_health
      retries: 3
      delay: 30
      until: controlplane_health.rc == 0
      failed_when: false

    - name: Display control plane health status
      debug:
        msg: "{{ item.host.name }}: {{ 'HEALTHY' if item.rc == 0 else 'NOT READY' }}"
      loop: "{{ controlplane_health.results }}"

    - name: Wait for worker nodes to be healthy and ready
      command: >
        talosctl health
        --nodes {{ host.static_ip }}
        --endpoints {{ host.static_ip }}
        --talosconfig {{ talosconfig_file }}
        --wait-timeout 10m
      loop: "{{ worker_hosts }}"
      loop_control:
        loop_var: host
        label: "{{ host.name }} ({{ host.static_ip }})"
      register: worker_health
      retries: 3
      delay: 30
      until: worker_health.rc == 0
      failed_when: false
      when: worker_hosts | length > 0

    - name: Display worker health status
      debug:
        msg: "{{ item.host.name }}: {{ 'HEALTHY' if item.rc == 0 else 'NOT READY' }}"
      loop: "{{ worker_health.results }}"
      when: worker_hosts | length > 0

    - name: Verify etcd service is available on first control plane
      command: >
        talosctl service etcd
        --nodes {{ first_controlplane.static_ip }}
        --endpoints {{ first_controlplane.static_ip }}
        --talosconfig {{ talosconfig_file }}
      register: etcd_service_check
      retries: 10
      delay: 30
      until: etcd_service_check.rc == 0
      failed_when: false

    - name: Display etcd service status
      debug:
        msg: "etcd service on {{ first_controlplane.name }}: {{ 'READY' if etcd_service_check.rc == 0 else 'NOT READY' }}"

    - name: Fail if control plane nodes are not healthy
      fail:
        msg: "One or more control plane nodes failed health checks. Cannot proceed."
      when: controlplane_health.results | selectattr('rc', 'ne', 0) | list | length > 0

    - name: Check if cluster is already bootstrapped
      command: >
        talosctl etcd members
        --nodes {{ first_controlplane.static_ip }}
        --endpoints {{ first_controlplane.static_ip }}
        --talosconfig {{ talosconfig_file }}
      register: bootstrap_check
      failed_when: false
      changed_when: false

    - name: Display next steps message
      debug:
        msg:
          - "========================================================================="
          - "Talos Node Deployment Complete!"
          - "========================================================================="
          - ""
          - "All nodes have been configured and are healthy."
          - ""
          - "{% if bootstrap_check.rc == 0 %}Cluster Status: etcd is ALREADY BOOTSTRAPPED{% else %}Cluster Status: NOT BOOTSTRAPPED (ready to bootstrap){% endif %}"
          - ""
          - "Control Plane Nodes ({{ controlplane_hosts | length }}):"
          - "{% for host in controlplane_hosts %}  - {{ host.name }} ({{ host.static_ip }}){% endfor %}"
          - ""
          - "Worker Nodes ({{ worker_hosts | length }}):"
          - "{% for host in worker_hosts %}  - {{ host.name }} ({{ host.static_ip }}){% endfor %}"
          - ""
          - "{% if bootstrap_check.rc != 0 %}========================================================================="
          - "NEXT STEP: Bootstrap the cluster"
          - "========================================================================="
          - ""
          - "Run the bootstrap playbook to initialize etcd and extract kubeconfig:"
          - "  ansible-playbook -i inventory.yml playbooks/bootstrap-talos-cluster.yml"
          - ""
          - "This will:"
          - "  1. Bootstrap etcd on first control plane node"
          - "  2. Wait for Kubernetes API to be ready"
          - "  3. Extract kubeconfig to ~/.kube/config"
          - "  4. Verify cluster access"
          - "{% endif %}"
          - "========================================================================="

    - name: Create deployment summary
      copy:
        content: |
          # Talos Node Deployment Summary

          Deployment Date: {{ ansible_date_time.iso8601 }}
          Deployed By: {{ ansible_env.USER }}@{{ ansible_hostname }}

          ## Deployment Status

          All nodes have been configured and passed health checks.

          {% if bootstrap_check.rc == 0 %}
          **Cluster Status:** etcd is ALREADY BOOTSTRAPPED
          {% else %}
          **Cluster Status:** NOT BOOTSTRAPPED (ready to bootstrap)
          {% endif %}

          ## Nodes Deployed

          ### Control Plane Nodes
          {% for host in controlplane_hosts %}
          - {{ host.name }} ({{ host.static_ip }})
          {% endfor %}

          ### Worker Nodes
          {% for host in worker_hosts %}
          - {{ host.name }} ({{ host.static_ip }})
          {% endfor %}

          ## Access Information

          ### Talos Configuration
          - Talosconfig: {{ talosconfig_file }}
          - Usage: `export TALOSCONFIG={{ talosconfig_file }}`

          ## Verification Commands

          Check node health:
          ```bash
          talosctl health --nodes {{ first_controlplane.static_ip }} --endpoints {{ first_controlplane.static_ip }} --talosconfig {{ talosconfig_file }}
          ```

          Check all services:
          ```bash
          talosctl services --nodes {{ first_controlplane.static_ip }} --talosconfig {{ talosconfig_file }}
          ```

          Check etcd service status:
          ```bash
          talosctl service etcd --nodes {{ first_controlplane.static_ip }} --talosconfig {{ talosconfig_file }}
          ```

          {% if bootstrap_check.rc != 0 %}
          ## Next Step: Bootstrap the Cluster

          Run the bootstrap playbook to initialize etcd and extract kubeconfig:

          ```bash
          ansible-playbook -i inventory.yml playbooks/bootstrap-talos-cluster.yml
          ```

          This will:
          1. Bootstrap etcd on the first control plane node
          2. Wait for Kubernetes API to be ready
          3. Extract kubeconfig to ~/.kube/config
          4. Verify cluster access

          After bootstrapping, nodes will show NotReady until CNI is installed.
          {% else %}
          ## Cluster Already Bootstrapped

          Your cluster is already running. You can extract kubeconfig with:

          ```bash
          talosctl kubeconfig --nodes {{ first_controlplane.static_ip }} --talosconfig {{ talosconfig_file }}
          ```

          Or bootstrap again by running:

          ```bash
          ansible-playbook -i inventory.yml playbooks/bootstrap-talos-cluster.yml
          ```
          {% endif %}

          ## Configuration Files
          - All Talos configs: {{ talos_config_dir }}/
          - Secrets: {{ talos_secrets_file }} (KEEP SECURE!)
        dest: "{{ talos_config_dir }}/DEPLOYMENT.md"
        mode: '0644'
