---
- name: Check Status of All Machines in Inventory
  hosts: localhost
  gather_facts: false
  vars:
    talosconfig_path: "{{ playbook_dir }}/../talos-configs/talosconfig"
    status_results: []

  tasks:
    - name: Check if talosctl is available
      ansible.builtin.command: which talosctl
      register: talosctl_check
      failed_when: false
      changed_when: false

    - name: Fail if talosctl is not installed
      ansible.builtin.fail:
        msg: "talosctl is not installed or not in PATH. Please install it first."
      when: talosctl_check.rc != 0

    - name: Check if talosconfig exists
      ansible.builtin.stat:
        path: "{{ talosconfig_path }}"
      register: talosconfig_stat

    - name: Display talosconfig status
      ansible.builtin.debug:
        msg: "Talosconfig found at {{ talosconfig_path }}"
      when: talosconfig_stat.stat.exists

    - name: Display warning if no talosconfig
      ansible.builtin.debug:
        msg: "No talosconfig found - will only attempt insecure checks"
      when: not talosconfig_stat.stat.exists

    - name: Try to read dnsmasq leases file
      slurp:
        src: /var/lib/misc/dnsmasq.leases
      register: dnsmasq_leases_raw
      become: yes
      failed_when: false

    - name: Parse dnsmasq leases if available
      set_fact:
        dnsmasq_lease_map: >-
          {{
            dnsmasq_lease_map | default({}) |
            combine({
              item.split()[1] | lower: item.split()[2]
            })
          }}
      loop: "{{ (dnsmasq_leases_raw.content | b64decode).split('\n') }}"
      when:
        - dnsmasq_leases_raw.content is defined
        - item | length > 0

    - name: Build host list with both static and dynamic IPs
      set_fact:
        hosts_to_check: >-
          {{
            hosts_to_check | default([]) +
            [{
              'name': item.name,
              'mac': item.mac,
              'static_ip': item.ip,
              'dynamic_ip': dnsmasq_lease_map[item.mac | lower] | default(none),
              'role': item.role
            }]
          }}
      loop: "{{ pxe_hosts }}"

    - name: Display IP detection results
      debug:
        msg:
          - "IP Address Detection:"
          - "{% for host in hosts_to_check %}  {{ host.name }}:\n    Static IP: {{ host.static_ip }}\n    Dynamic IP (PXE): {{ host.dynamic_ip if host.dynamic_ip else 'Not found in leases' }}\n{% endfor %}"

    - name: Detect mode for each host (try dynamic IP first, then static)
      ansible.builtin.shell: |
        # Try dynamic IP first (PXE/maintenance mode scenario)
        {% if item.dynamic_ip %}
        RESULT=$(timeout 10 talosctl version --insecure --nodes {{ item.dynamic_ip }} --short 2>&1)
        if echo "$RESULT" | grep -q "Talos"; then
          echo "IP_USED={{ item.dynamic_ip }}"
          echo "$RESULT"
          exit 0
        fi
        {% endif %}
        # Try static IP (configured node scenario)
        RESULT=$(timeout 10 talosctl version --insecure --nodes {{ item.static_ip }} --short 2>&1)
        if echo "$RESULT" | grep -q "Talos"; then
          echo "IP_USED={{ item.static_ip }}"
          echo "$RESULT"
          exit 0
        fi
        # Neither worked
        echo "IP_USED=NONE"
        echo "$RESULT"
        exit 1
      register: mode_detection
      loop: "{{ hosts_to_check }}"
      changed_when: false
      failed_when: false

    - name: Extract working IP for each host
      set_fact:
        hosts_with_working_ip: >-
          {{
            hosts_with_working_ip | default([]) +
            [{
              'name': item.item.name,
              'static_ip': item.item.static_ip,
              'dynamic_ip': item.item.dynamic_ip,
              'working_ip': (item.stdout.split('\n')[0] | regex_replace('^IP_USED=', '')) if (item.stdout is defined and 'IP_USED=' in item.stdout) else 'NONE',
              'role': item.item.role,
              'mac': item.item.mac
            }]
          }}
      loop: "{{ mode_detection.results }}"

    - name: Display which IPs are working
      debug:
        msg:
          - "Working IPs detected:"
          - "{% for host in hosts_with_working_ip %}  {{ host.name }}: {{ host.working_ip }} {% if host.working_ip == host.dynamic_ip %}(DYNAMIC/PXE){% elif host.working_ip == host.static_ip %}(STATIC/CONFIGURED){% else %}(UNREACHABLE){% endif %}\n{% endfor %}"

    - name: Check version for secured hosts (authenticated)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 10 talosctl version --nodes {{ working_ip }} --endpoints {{ working_ip }} --talosconfig {{ talosconfig_path }} --short 2>&1 || true
      register: authenticated_version
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - talosconfig_stat.stat.exists
        - item.stdout is defined
        - "'certificate required' in item.stdout.lower() or 'tls:' in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check health for secured hosts (authenticated)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 10 talosctl health --nodes {{ working_ip }} --endpoints {{ working_ip }} --talosconfig {{ talosconfig_path }} 2>&1 || true
      register: authenticated_health
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - talosconfig_stat.stat.exists
        - item.stdout is defined
        - "'certificate required' in item.stdout.lower() or 'tls:' in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check services for secured hosts (authenticated)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 5 talosctl services --nodes {{ working_ip }} --endpoints {{ working_ip }} --talosconfig {{ talosconfig_path }} 2>&1 || true
      register: authenticated_services
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - talosconfig_stat.stat.exists
        - item.stdout is defined
        - "'certificate required' in item.stdout.lower() or 'tls:' in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check machine config for secured hosts (authenticated)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 5 talosctl get machineconfig --nodes {{ working_ip }} --endpoints {{ working_ip }} --talosconfig {{ talosconfig_path }} 2>&1 || true
      register: authenticated_machineconfig
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - talosconfig_stat.stat.exists
        - item.stdout is defined
        - "'certificate required' in item.stdout.lower() or 'tls:' in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check extensions for secured hosts (authenticated)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 5 talosctl get extensions --nodes {{ working_ip }} --endpoints {{ working_ip }} --talosconfig {{ talosconfig_path }} 2>&1 || true
      register: authenticated_extensions
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - talosconfig_stat.stat.exists
        - item.stdout is defined
        - "'certificate required' in item.stdout.lower() or 'tls:' in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check health for insecure hosts (maintenance mode)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 10 talosctl health --nodes {{ working_ip }} 2>&1 || true
      register: insecure_health
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - item.stdout is defined
        - "'certificate required' not in item.stdout.lower()"
        - "'tls:' not in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check services for insecure hosts (maintenance mode)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 5 talosctl services --nodes {{ working_ip }} 2>&1 || true
      register: insecure_services
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - item.stdout is defined
        - "'certificate required' not in item.stdout.lower()"
        - "'tls:' not in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Check machine config for insecure hosts (maintenance mode)
      ansible.builtin.shell: |
        {% set working_ip = hosts_with_working_ip[idx].working_ip %}
        timeout 5 talosctl get machineconfig --nodes {{ working_ip }} 2>&1 || true
      register: insecure_machineconfig
      loop: "{{ mode_detection.results }}"
      loop_control:
        index_var: idx
      changed_when: false
      failed_when: false
      when:
        - item.stdout is defined
        - "'certificate required' not in item.stdout.lower()"
        - "'tls:' not in item.stdout.lower()"
        - hosts_with_working_ip[idx].working_ip != 'NONE'

    - name: Build status summary
      ansible.builtin.set_fact:
        status_results: "{{ status_results + [result] }}"
      loop: "{{ hosts_with_working_ip }}"
      loop_control:
        index_var: idx
      vars:
        mode_check: "{{ mode_detection.results[idx] }}"
        is_secured: "{{ mode_check.stdout is defined and ('certificate required' in mode_check.stdout.lower() or 'tls:' in mode_check.stdout.lower()) }}"
        # Find matching results from sparse arrays using working_ip
        auth_ver_result: "{{ authenticated_version.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        auth_health_result: "{{ authenticated_health.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        auth_services_result: "{{ authenticated_services.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        auth_mconfig_result: "{{ authenticated_machineconfig.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        auth_extensions_result: "{{ authenticated_extensions.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        insec_health_result: "{{ insecure_health.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        insec_services_result: "{{ insecure_services.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        insec_mconfig_result: "{{ insecure_machineconfig.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first | default({}) }}"
        # Select the right version based on mode
        version_output: "{{ auth_ver_result.stdout if is_secured else mode_check.stdout }}"
        health_output: "{{ auth_health_result.stdout if is_secured else insec_health_result.stdout }}"
        services_output: "{{ auth_services_result.stdout if is_secured else insec_services_result.stdout }}"
        mconfig_output: "{{ auth_mconfig_result.stdout if is_secured else insec_mconfig_result.stdout }}"
        extensions_output: "{{ auth_extensions_result.stdout if is_secured else '' }}"
        result:
          hostname: "{{ item.name }}"
          ip: "{{ item.working_ip }}"
          ip_type: "{{ 'dynamic' if item.working_ip == item.dynamic_ip else 'static' if item.working_ip == item.static_ip else 'unknown' }}"
          static_ip: "{{ item.static_ip }}"
          dynamic_ip: "{{ item.dynamic_ip }}"
          role: "{{ item.role }}"
          mode: "{{ 'SECURED' if is_secured else 'INSECURE' }}"
          stage: >-
            {{
              'RUNNING_CONFIGURED' if (
                is_secured or
                (mconfig_output is defined and 'v1alpha1.MachineConfig' in mconfig_output)
              )
              else ('MAINTENANCE' if (
                (health_output is defined and 'maintenance mode' in health_output.lower()) or
                (version_output is defined and 'maintenance mode' in version_output.lower()) or
                (mconfig_output is defined and 'maintenance mode' in mconfig_output.lower())
              )
              else ('RUNNING_UNCONFIGURED' if (version_output is defined and 'Talos' in version_output and 'maintenance mode' not in version_output.lower())
              else 'UNREACHABLE'))
            }}
          has_config: >-
            {{
              'YES' if (mconfig_output is defined and 'v1alpha1.MachineConfig' in mconfig_output)
              else ('NO' if (mconfig_output is defined and ('not found' in mconfig_output.lower() or 'maintenance mode' in mconfig_output.lower()))
              else 'UNKNOWN')
            }}
          health_status: >-
            {{
              'HEALTHY' if (health_output is defined and 'is healthy' in health_output)
              else ('MAINTENANCE' if (health_output is defined and 'maintenance mode' in health_output.lower())
              else ('ERROR' if (health_output is defined and health_output != '')
              else 'NO_RESPONSE'))
            }}
          error_summary: >-
            {{
              (health_output | regex_search('error:.*', ignorecase=True) | default(''))
              | regex_replace('^error:\s*', '', ignorecase=True) | trim
              if (health_output is defined and 'error' in health_output.lower())
              else (version_output | regex_search('error.*', ignorecase=True) | default('') | trim
              if (version_output is defined and 'error' in version_output.lower())
              else '')
            }}
          version: >-
            {{
              (version_output | regex_search('Talos v[0-9.]+') | default(''))
              if (version_output is defined and 'Talos' in version_output)
              else ''
            }}
          services_running: >-
            {{
              (services_output | regex_findall('Running', ignorecase=True) | length)
              if (services_output is defined and services_output != '')
              else 0
            }}
          extensions: >-
            {{
              (extensions_output.split('\n') | select('match', '^runtime\\s+ExtensionStatus') | map('regex_replace', '^runtime\\s+ExtensionStatus\\s+\\S+\\s+\\S+\\s+(\\S+).*', '\\1') | list)
              if (extensions_output is defined and extensions_output != '' and 'ExtensionStatus' in extensions_output)
              else []
            }}

    - name: Generate summary statistics
      ansible.builtin.set_fact:
        hosts_healthy: "{{ status_results | selectattr('health_status', 'equalto', 'HEALTHY') | list | length }}"
        secured_hosts: "{{ status_results | selectattr('mode', 'equalto', 'SECURED') | list | length }}"
        insecure_hosts: "{{ status_results | selectattr('mode', 'equalto', 'INSECURE') | list | length }}"

    - name: Save raw outputs to file for debugging
      ansible.builtin.copy:
        dest: "/tmp/talos-raw-output-{{ item.name | regex_replace('\\..*', '') }}.txt"
        content: |
          Host: {{ item.name }} ({{ item.working_ip }})
          IP Type: {{ 'Dynamic' if item.working_ip == item.dynamic_ip else 'Static' if item.working_ip == item.static_ip else 'Unknown' }}
          Static IP: {{ item.static_ip }}
          Dynamic IP: {{ item.dynamic_ip if item.dynamic_ip else 'N/A' }}
          ================================================================================

          MODE DETECTION (version check):
          {{ mode_detection.results[idx].stdout }}
          {{ mode_detection.results[idx].stderr }}

          {% if status_results[idx].mode == 'SECURED' %}
          AUTHENTICATED CHECKS:

          Health Check:
          {{ (authenticated_health.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Version Check:
          {{ (authenticated_version.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Machine Config:
          {{ (authenticated_machineconfig.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Services:
          {{ (authenticated_services.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Extensions:
          {{ (authenticated_extensions.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}
          {% else %}
          INSECURE CHECKS:

          Health Check:
          {{ (insecure_health.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Machine Config:
          {{ (insecure_machineconfig.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}

          Services:
          {{ (insecure_services.results | selectattr('item.item.working_ip', 'equalto', item.working_ip) | list | first).stdout | default('N/A') }}
          {% endif %}
      loop: "{{ hosts_with_working_ip }}"
      loop_control:
        index_var: idx
        label: "{{ item.name }}"

    - name: Display detailed status for each host
      ansible.builtin.debug:
        msg:
          - "================================================================================"
          - "Host: {{ item.hostname }}"
          - "  IP: {{ item.ip }} ({{ item.ip_type }}) | Role: {{ item.role }}"
          - "{% if item.ip_type == 'dynamic' %}  Note: Using dynamic IP (PXE/maintenance mode) - Static IP: {{ item.static_ip }}{% endif %}"
          - "{% if item.ip_type == 'static' %}  Static IP active (configured node) - Dynamic IP was: {{ item.dynamic_ip if item.dynamic_ip else 'N/A' }}{% endif %}"
          - "  Mode: {{ item.mode }} | Stage: {{ item.stage }} | Has Config: {{ item.has_config }}"
          - "  Version: {{ item.version if item.version else 'N/A' }}"
          - "  Health: {{ item.health_status }}"
          - "{% if item.extensions | length > 0 %}  Extensions: {{ item.extensions | join(', ') }}{% endif %}"
          - "{% if item.error_summary %}  Error: {{ item.error_summary }}{% endif %}"
          - "  Raw output saved to: /tmp/talos-raw-output-{{ item.hostname | regex_replace('\\..*', '') }}.txt"
          - "================================================================================"
      loop: "{{ status_results }}"
      loop_control:
        label: "{{ item.hostname }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - ""
          - "================================================================================"
          - "SUMMARY - {{ hosts_with_working_ip | length }} Total Hosts"
          - "================================================================================"
          - "IP Address Types:"
          - "  Using Dynamic IPs: {{ status_results | selectattr('ip_type', 'equalto', 'dynamic') | list | length }}"
          - "  Using Static IPs:  {{ status_results | selectattr('ip_type', 'equalto', 'static') | list | length }}"
          - ""
          - "Mode:"
          - "  Secured (TLS):  {{ secured_hosts }}"
          - "  Insecure:       {{ insecure_hosts }}"
          - ""
          - "Health:"
          - "  Healthy: {{ hosts_healthy }}"
          - ""
          - "Stages:"
          - "  Maintenance:          {{ status_results | selectattr('stage', 'equalto', 'MAINTENANCE') | list | length }}"
          - "  Running (Configured): {{ status_results | selectattr('stage', 'equalto', 'RUNNING_CONFIGURED') | list | length }}"
          - "  Running (No Config):  {{ status_results | selectattr('stage', 'equalto', 'RUNNING_UNCONFIGURED') | list | length }}"
          - "  Unreachable:          {{ status_results | selectattr('stage', 'equalto', 'UNREACHABLE') | list | length }}"
          - ""
          - "Machine Config:"
          - "  Has Config: {{ status_results | selectattr('has_config', 'equalto', 'YES') | list | length }}"
          - "  No Config:  {{ status_results | selectattr('has_config', 'equalto', 'NO') | list | length }}"
          - "================================================================================"
