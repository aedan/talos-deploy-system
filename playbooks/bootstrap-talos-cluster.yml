---
- name: Bootstrap Talos Linux cluster etcd and Kubernetes
  hosts: localhost
  gather_facts: yes
  vars:
    talos_config_dir: "{{ playbook_dir }}/../talos-configs"
    talos_secrets_file: "{{ talos_config_dir }}/secrets.yaml"
    talosconfig_file: "{{ talos_config_dir }}/talosconfig"
    kubeconfig_dest: "{{ ansible_env.HOME }}/.kube/config"
    etcd_ready_timeout: 600  # 10 minutes for etcd to become ready

  tasks:
    - name: Verify talos-configs directory exists
      stat:
        path: "{{ talos_config_dir }}"
      register: config_dir_stat
      failed_when: not config_dir_stat.stat.exists

    - name: Verify talosconfig exists
      stat:
        path: "{{ talosconfig_file }}"
      register: talosconfig_stat
      failed_when: not talosconfig_stat.stat.exists

    - name: Set inventory variables as facts
      set_fact:
        pxe_hosts: "{{ hostvars[inventory_hostname]['pxe_hosts'] }}"
        talos_cluster_name: "{{ hostvars[inventory_hostname]['talos_cluster_name'] }}"
        talos_cluster_endpoint: "{{ hostvars[inventory_hostname]['talos_cluster_endpoint'] }}"
        talos_kubernetes_version: "{{ hostvars[inventory_hostname]['talos_kubernetes_version'] }}"

    - name: Filter control plane and worker nodes
      set_fact:
        controlplane_hosts: "{{ pxe_hosts | selectattr('role', 'equalto', 'controlplane') | list }}"
        worker_hosts: "{{ pxe_hosts | selectattr('role', 'equalto', 'worker') | list }}"
        first_controlplane: "{{ (pxe_hosts | selectattr('role', 'equalto', 'controlplane') | list)[0] }}"

    - name: Display bootstrap plan
      debug:
        msg:
          - "========================================="
          - "Talos Cluster Bootstrap"
          - "========================================="
          - "Bootstrap Node: {{ first_controlplane.name }} ({{ first_controlplane.ip }})"
          - "Control Plane Nodes: {{ controlplane_hosts | length }}"
          - "Worker Nodes: {{ worker_hosts | length }}"
          - "========================================="

    - name: Pause for user confirmation
      pause:
        prompt: |

          This will bootstrap etcd on the first control plane node and extract kubeconfig.
          Make sure all nodes have been deployed and are healthy.

          Press ENTER to continue or Ctrl+C to abort...

    - name: Check if etcd is already bootstrapped by checking for members
      command: >
        talosctl etcd members
        --nodes {{ first_controlplane.ip }}
        --endpoints {{ first_controlplane.ip }}
        --talosconfig {{ talosconfig_file }}
      register: bootstrap_check
      failed_when: false
      changed_when: false

    - name: Display etcd bootstrap status
      debug:
        msg: "etcd cluster {{ 'ALREADY BOOTSTRAPPED' if bootstrap_check.rc == 0 else 'NOT BOOTSTRAPPED - will bootstrap now' }}"

    - name: Bootstrap etcd cluster on first control plane node
      command: >
        talosctl bootstrap
        -e {{ first_controlplane.ip }}
        --talosconfig {{ talosconfig_file }}
        --nodes {{ first_controlplane.ip }}
      when: bootstrap_check.rc != 0
      register: bootstrap_result
      failed_when: false
      timeout: 300

    - name: Display bootstrap result
      debug:
        msg: "Bootstrap command {{ 'executed successfully' if bootstrap_result.rc == 0 else 'returned error code ' + (bootstrap_result.rc | string) }}"
      when: bootstrap_result.changed | default(false)

    - name: Wait for etcd to initialize after bootstrap
      pause:
        seconds: 60
        prompt: "Waiting for etcd to initialize..."
      when: bootstrap_result.changed | default(false)

    - name: Wait for etcd cluster to be fully operational
      command: >
        talosctl etcd members
        --nodes {{ first_controlplane.ip }}
        --endpoints {{ first_controlplane.ip }}
        --talosconfig {{ talosconfig_file }}
      register: etcd_health_check
      retries: 20
      delay: 30
      until: etcd_health_check.rc == 0
      when: bootstrap_check.rc != 0 or (bootstrap_result.changed | default(false))

    - name: Display etcd cluster members
      debug:
        msg: "{{ etcd_health_check.stdout_lines }}"
      when: etcd_health_check is defined and etcd_health_check.rc == 0

    - name: Wait for Kubernetes API to respond
      command: >
        talosctl get members
        --nodes {{ first_controlplane.ip }}
        --endpoints {{ first_controlplane.ip }}
        --talosconfig {{ talosconfig_file }}
      register: api_check
      retries: 15
      delay: 20
      until: api_check.rc == 0

    - name: Create .kube directory
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0755'

    - name: Check if kubeconfig already exists
      stat:
        path: "{{ kubeconfig_dest }}"
      register: existing_kubeconfig

    - name: Backup existing kubeconfig
      copy:
        src: "{{ kubeconfig_dest }}"
        dest: "{{ kubeconfig_dest }}.backup.{{ ansible_date_time.epoch }}"
        mode: '0600'
        remote_src: yes
      when: existing_kubeconfig.stat.exists

    - name: Extract kubeconfig from cluster
      command: >
        talosctl kubeconfig
        --nodes {{ first_controlplane.ip }}
        --endpoints {{ first_controlplane.ip }}
        --talosconfig {{ talosconfig_file }}
        --force
        {{ kubeconfig_dest }}
      register: kubeconfig_extract

    - name: Set kubeconfig permissions
      file:
        path: "{{ kubeconfig_dest }}"
        mode: '0600'

    - name: Verify cluster access
      command: kubectl get nodes
      environment:
        KUBECONFIG: "{{ kubeconfig_dest }}"
      register: cluster_nodes
      retries: 5
      delay: 10
      until: cluster_nodes.rc == 0

    - name: Display cluster status
      debug:
        msg:
          - "NOTE: Nodes will show NotReady until CNI (kube-ovn) is installed"
          - "{{ cluster_nodes.stdout_lines }}"

    - name: Get cluster info
      command: kubectl cluster-info
      environment:
        KUBECONFIG: "{{ kubeconfig_dest }}"
      register: cluster_info

    - name: Create deployment summary
      copy:
        content: |
          # Talos Cluster Bootstrap Summary

          Bootstrap Date: {{ ansible_date_time.iso8601 }}
          Bootstrap By: {{ ansible_env.USER }}@{{ ansible_hostname }}

          ## Cluster Information
          - Cluster Name: {{ talos_cluster_name }}
          - Endpoint: {{ talos_cluster_endpoint }}
          - Kubernetes Version: {{ talos_kubernetes_version }}

          ## Nodes in Cluster

          ### Control Plane Nodes
          {% for host in controlplane_hosts %}
          - {{ host.name }} ({{ host.ip }})
          {% endfor %}

          ### Worker Nodes
          {% for host in worker_hosts %}
          - {{ host.name }} ({{ host.ip }})
          {% endfor %}

          ## Access Information

          ### Talos Configuration
          - Talosconfig: {{ talosconfig_file }}
          - Usage: `export TALOSCONFIG={{ talosconfig_file }}`

          ### Kubernetes Configuration
          - Kubeconfig: {{ kubeconfig_dest }}
          - Usage: `export KUBECONFIG={{ kubeconfig_dest }}`

          ### Quick Access Commands
          ```bash
          # Check Talos nodes
          talosctl --talosconfig {{ talosconfig_file }} --nodes {{ first_controlplane.ip }} get members

          # Check Kubernetes nodes
          kubectl get nodes -o wide

          # View system pods
          kubectl get pods -A

          # Talos dashboard (if available)
          talosctl dashboard --nodes {{ first_controlplane.ip }} --talosconfig {{ talosconfig_file }}
          ```

          ## Current Cluster Status

          ```
          {{ cluster_nodes.stdout }}
          ```

          ## Cluster Info

          ```
          {{ cluster_info.stdout }}
          ```

          ## Next Steps

          **IMPORTANT:** Nodes will show NotReady status until CNI is installed.

          1. **Install kube-ovn CNI** (Cluster networking - REQUIRED)
             ```bash
             # Install kube-ovn
             # Follow kube-ovn installation instructions for your version
             # https://github.com/kubeovn/kube-ovn

             # Verify CNI is running
             kubectl get pods -n kube-system -l app=kube-ovn-cni

             # Wait for nodes to become Ready
             kubectl get nodes -w
             ```

          2. **Install Longhorn** (Storage)
             ```bash
             kubectl apply -f https://raw.githubusercontent.com/longhorn/longhorn/v1.7.2/deploy/longhorn.yaml

             # Wait for Longhorn to be ready
             kubectl -n longhorn-system get pods

             # Set as default storage class (optional)
             kubectl patch storageclass longhorn -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
             ```

          3. **Verify Cluster Health** (after CNI installation)
             ```bash
             # Check all nodes are Ready (will be NotReady without CNI)
             kubectl get nodes

             # Check all system pods are running
             kubectl get pods -A

             # Check etcd health via Talos
             talosctl --nodes {{ first_controlplane.ip }} etcd members
             ```

          4. **Deploy your applications**
             ```bash
             kubectl apply -f your-app.yaml
             ```

          ## Troubleshooting

          ### Check Talos Service Status
          ```bash
          talosctl --nodes {{ first_controlplane.ip }} services
          ```

          ### View Talos Logs
          ```bash
          # Kubelet logs
          talosctl --nodes {{ first_controlplane.ip }} logs kubelet

          # API server logs
          talosctl --nodes {{ first_controlplane.ip }} logs controller-runtime
          ```

          ### Check etcd Health
          ```bash
          talosctl --nodes {{ first_controlplane.ip }} etcd members
          ```

          ### Reset a Node (DANGER!)
          ```bash
          talosctl --nodes <node-ip> reset --graceful=false --reboot
          ```

          ## Backup Information

          {% if existing_kubeconfig.stat.exists %}
          Previous kubeconfig backed up to: {{ kubeconfig_dest }}.backup.{{ ansible_date_time.epoch }}
          {% else %}
          No previous kubeconfig found.
          {% endif %}

          ## Configuration Files
          - All Talos configs: {{ talos_config_dir }}/
          - Secrets: {{ talos_secrets_file }} (KEEP SECURE!)
        dest: "{{ talos_config_dir }}/BOOTSTRAP.md"
        mode: '0644'

    - name: Display completion message
      debug:
        msg:
          - "========================================================================="
          - "Talos Cluster Bootstrap Complete!"
          - "========================================================================="
          - ""
          - "Kubeconfig: {{ kubeconfig_dest }}"
          - "Talosconfig: {{ talosconfig_file }}"
          - ""
          - "Quick start:"
          - "  kubectl get nodes  # Will show NotReady until CNI installed"
          - "  kubectl get pods -A"
          - "  talosctl --nodes {{ first_controlplane.ip }} etcd members"
          - ""
          - "IMPORTANT: Nodes will be NotReady until kube-ovn CNI is installed!"
          - "  This is expected. etcd and Kubernetes API are running."
          - "  See {{ talos_config_dir }}/BOOTSTRAP.md for next steps"
          - ""
          - "========================================================================="
