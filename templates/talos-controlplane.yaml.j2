version: v1alpha1
debug: false
persist: true

machine:
    type: controlplane
    token: {{ talos_machine_token }}
    ca:
        crt: {{ talos_machine_ca_crt }}
        key: {{ talos_machine_ca_key }}
    certSANs: []

    kubelet:
        extraMounts:
            - destination: {{ longhorn_mount_path }}
              type: bind
              source: {{ longhorn_mount_path }}
              options:
                  - bind
                  - rshared
                  - rw
        nodeIP:
            validSubnets:
                - {{ host.ip | ansible.utils.ipaddr('network') }}/{{ network_netmask }}
{% if not kubespan_enabled %}
                - "!100.64.0.0/10"
{% endif %}
                - "!10.64.0.0/16"
        image: ghcr.io/siderolabs/kubelet:{{ talos_kubernetes_version }}
        defaultRuntimeSeccompProfileEnabled: true
        disableManifestsDirectory: true

    network:
      hostname: {{ host.name.split('.')[0] }}
      interfaces:
{% if host.network_config is defined %}
{# Advanced networking configuration from per-host network_config #}
{% for iface_config in host.network_config %}
        - interface: {{ iface_config.interface }}
{% if iface_config.addresses is defined %}
          addresses:
{% for addr in iface_config.addresses %}
            - {{ addr }}
{% endfor %}
{% endif %}
{% if iface_config.mtu is defined %}
          mtu: {{ iface_config.mtu }}
{% endif %}
{% if iface_config.vlan is defined %}
          vlan:
            vlanId: {{ iface_config.vlan.vlanId }}
{% if iface_config.vlan.vlanProtocol is defined %}
            vlanProtocol: {{ iface_config.vlan.vlanProtocol }}
{% endif %}
{% endif %}
{% if iface_config.bond is defined %}
          bond:
            mode: {{ iface_config.bond.mode }}
{% if iface_config.bond.lacpRate is defined %}
            lacpRate: {{ iface_config.bond.lacpRate }}
{% endif %}
{% if iface_config.bond.miimon is defined %}
            miimon: {{ iface_config.bond.miimon }}
{% endif %}
{% if iface_config.bond.updelay is defined %}
            updelay: {{ iface_config.bond.updelay }}
{% endif %}
{% if iface_config.bond.downdelay is defined %}
            downdelay: {{ iface_config.bond.downdelay }}
{% endif %}
{% if iface_config.bond.xmitHashPolicy is defined %}
            xmitHashPolicy: {{ iface_config.bond.xmitHashPolicy }}
{% endif %}
            interfaces:
{% for bond_iface in iface_config.bond.interfaces %}
              - {{ bond_iface }}
{% endfor %}
{% endif %}
{% if iface_config.routes is defined %}
          routes:
{% for route in iface_config.routes %}
            - network: {{ route.network }}
              gateway: {{ route.gateway }}
{% if route.metric is defined %}
              metric: {{ route.metric }}
{% endif %}
{% endfor %}
{% endif %}
{% if iface_config.dhcp is defined %}
          dhcp: {{ iface_config.dhcp | lower }}
{% endif %}
{% endfor %}
{% else %}
{# Simple networking configuration (backward compatible) #}
        - interface: {{ network_primary_interface }}
          addresses:
            - {{ host.ip }}/{{ network_netmask }}
          mtu: {{ network_mtu }}
          routes:
            - network: 0.0.0.0/0
              gateway: {{ network_gateway }}
{% endif %}
{% for iface in host.ignored_interfaces | default(network_ignored_interfaces) %}
        - interface: {{ iface }}
          ignore: true
{% endfor %}
      nameservers:
{% for ns in network_nameservers %}
        - {{ ns }}
{% endfor %}
{% if kubespan_enabled %}
      kubespan:
        enabled: true
{% endif %}

    time:
      servers:
        - time.cloudflare.com

    install:
        disk: {{ host.install_disk }}
        image: factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}
        wipe: false

    registries: {}

    features:
        rbac: true
        stableHostname: true
        apidCheckExtKeyUsage: true
        diskQuotaSupport: true
        kubePrism:
            enabled: true
            port: 7445
        hostDNS:
            enabled: true
            forwardKubeDNSToHost: true

    nodeLabels:
        node.kubernetes.io/exclude-from-external-load-balancers: ""

cluster:
    id: {{ talos_cluster_id }}
    secret: {{ talos_cluster_secret }}
    controlPlane:
        endpoint: {{ talos_cluster_endpoint }}
    clusterName: {{ talos_cluster_name }}
    allowSchedulingOnControlPlanes: true
    network:
        dnsDomain: {{ talos_cluster_name }}
        podSubnets:
            - 10.244.0.0/16
        serviceSubnets:
            - 10.96.0.0/12
        cni:
          name: none

    token: {{ talos_bootstrap_token }}
    secretboxEncryptionSecret: {{ talos_secretbox_secret }}
    ca:
        crt: {{ talos_cluster_ca_crt }}
        key: {{ talos_cluster_ca_key }}
    aggregatorCA:
        crt: {{ talos_aggregator_ca_crt }}
        key: {{ talos_aggregator_ca_key }}
    serviceAccount:
        key: {{ talos_service_account_key }}

    apiServer:
        image: registry.k8s.io/kube-apiserver:{{ talos_kubernetes_version }}
        certSANs:
{% for san in talos_cert_sans %}
            - {{ san }}
{% endfor %}
        disablePodSecurityPolicy: true
        admissionControl:
            - name: PodSecurity
              configuration:
                apiVersion: pod-security.admission.config.k8s.io/v1alpha1
                defaults:
                    audit: restricted
                    audit-version: latest
                    enforce: baseline
                    enforce-version: latest
                    warn: restricted
                    warn-version: latest
                exemptions:
                    namespaces:
                        - kube-system
                    runtimeClasses: []
                    usernames: []
                kind: PodSecurityConfiguration
        auditPolicy:
            apiVersion: audit.k8s.io/v1
            kind: Policy
            rules:
                - level: Metadata

    controllerManager:
        image: registry.k8s.io/kube-controller-manager:{{ talos_kubernetes_version }}

    proxy:
        image: registry.k8s.io/kube-proxy:{{ talos_kubernetes_version }}

    scheduler:
        image: registry.k8s.io/kube-scheduler:{{ talos_kubernetes_version }}

    discovery:
        enabled: true
        registries:
            kubernetes:
                disabled: true
            service: {}

    etcd:
        ca:
            crt: {{ talos_etcd_ca_crt }}
            key: {{ talos_etcd_ca_key }}
        advertisedSubnets:
            - {{ management_subnet }}
        listenSubnets:
            - {{ management_subnet }}

    extraManifests: []
    inlineManifests: []
