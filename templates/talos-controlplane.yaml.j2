version: v1alpha1
debug: false
persist: true

machine:
    type: controlplane
    token: {{ talos_machine_token }}
    ca:
        crt: {{ talos_machine_ca_crt }}
        key: {{ talos_machine_ca_key }}
    certSANs: []

    kubelet:
        extraMounts:
            - destination: {{ longhorn_mount_path }}
              type: bind
              source: {{ longhorn_mount_path }}
              options:
                  - bind
                  - rshared
                  - rw
        image: ghcr.io/siderolabs/kubelet:{{ talos_kubernetes_version }}
        defaultRuntimeSeccompProfileEnabled: true
        disableManifestsDirectory: true

    network:
      hostname: {{ host.name.split('.')[0] }}
      interfaces:
        - interface: {{ network_primary_interface }}
          addresses:
            - {{ host.ip }}/{{ network_netmask }}
          mtu: {{ network_mtu }}
          routes:
            - network: 0.0.0.0/0
              gateway: {{ network_gateway }}
      nameservers:
{% for ns in network_nameservers %}
        - {{ ns }}
{% endfor %}

    time:
      servers:
        - time.cloudflare.com

    install:
        disk: {{ host.install_disk }}
        image: factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}
        wipe: false

    registries: {}

    features:
        rbac: true
        stableHostname: true
        apidCheckExtKeyUsage: true
        diskQuotaSupport: true
        kubePrism:
            enabled: true
            port: 7445
        hostDNS:
            enabled: true
            forwardKubeDNSToHost: true

    nodeLabels:
        node.kubernetes.io/exclude-from-external-load-balancers:
            $patch: delete

cluster:
    id: {{ talos_cluster_id }}
    secret: {{ talos_cluster_secret }}
    controlPlane:
        endpoint: {{ talos_cluster_endpoint }}
    clusterName: {{ talos_cluster_name }}
    allowSchedulingOnControlPlanes: true
    network:
        dnsDomain: {{ talos_cluster_name }}
        podSubnets:
            - 10.244.0.0/16
        serviceSubnets:
            - 10.96.0.0/12
        cni:
          name: none

    token: {{ talos_bootstrap_token }}
    secretboxEncryptionSecret: {{ talos_secretbox_secret }}
    ca:
        crt: {{ talos_cluster_ca_crt }}
        key: {{ talos_cluster_ca_key }}
    aggregatorCA:
        crt: {{ talos_aggregator_ca_crt }}
        key: {{ talos_aggregator_ca_key }}
    serviceAccount:
        key: {{ talos_service_account_key }}

    apiServer:
        image: registry.k8s.io/kube-apiserver:{{ talos_kubernetes_version }}
        certSANs:
{% for san in talos_cert_sans %}
            - {{ san }}
{% endfor %}
        disablePodSecurityPolicy: true
        admissionControl:
            - name: PodSecurity
              configuration:
                apiVersion: pod-security.admission.config.k8s.io/v1alpha1
                defaults:
                    audit: restricted
                    audit-version: latest
                    enforce: baseline
                    enforce-version: latest
                    warn: restricted
                    warn-version: latest
                exemptions:
                    namespaces:
                        - kube-system
                    runtimeClasses: []
                    usernames: []
                kind: PodSecurityConfiguration
        auditPolicy:
            apiVersion: audit.k8s.io/v1
            kind: Policy
            rules:
                - level: Metadata

    controllerManager:
        image: registry.k8s.io/kube-controller-manager:{{ talos_kubernetes_version }}

    proxy:
        image: registry.k8s.io/kube-proxy:{{ talos_kubernetes_version }}

    scheduler:
        image: registry.k8s.io/kube-scheduler:{{ talos_kubernetes_version }}

    discovery:
        enabled: true
        registries:
            kubernetes:
                disabled: true
            service: {}

    etcd:
        ca:
            crt: {{ talos_etcd_ca_crt }}
            key: {{ talos_etcd_ca_key }}

    extraManifests: []
    inlineManifests: []
