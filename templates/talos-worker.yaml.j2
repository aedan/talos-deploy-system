version: v1alpha1
debug: false
persist: true

machine:
    type: worker
    token: {{ talos_machine_token }}
    ca:
        crt: {{ talos_machine_ca_crt }}
    certSANs: []

    kubelet:
        extraMounts:
            - destination: {{ longhorn_mount_path }}
              type: bind
              source: {{ longhorn_mount_path }}
              options:
                  - bind
                  - rshared
                  - rw
        nodeIP:
            validSubnets:
                - {{ management_subnet }}
{% if not kubespan_enabled %}
                - "!100.64.0.0/10"
{% endif %}
                - "!10.64.0.0/16"
        image: ghcr.io/siderolabs/kubelet:{{ talos_kubernetes_version }}
        defaultRuntimeSeccompProfileEnabled: true
        disableManifestsDirectory: true

    network:
      hostname: {{ host.name.split('.')[0] }}
      interfaces:
        - interface: {{ network_primary_interface }}
          addresses:
            - {{ host.ip }}/{{ network_netmask }}
          mtu: {{ network_mtu }}
          routes:
            - network: 0.0.0.0/0
              gateway: {{ network_gateway }}
{% for iface in host.ignored_interfaces | default(network_ignored_interfaces) %}
        - interface: {{ iface }}
          ignore: true
{% endfor %}
      nameservers:
{% for ns in network_nameservers %}
        - {{ ns }}
{% endfor %}
{% if kubespan_enabled %}
      kubespan:
        enabled: true
{% endif %}

    time:
      servers:
        - time.cloudflare.com

    install:
        disk: {{ host.install_disk }}
        image: factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}
        wipe: false

    registries: {}

    features:
        rbac: true
        stableHostname: true
        apidCheckExtKeyUsage: true
        diskQuotaSupport: true
        kubePrism:
            enabled: true
            port: 7445
        hostDNS:
            enabled: true
            forwardKubeDNSToHost: true

cluster:
    id: {{ talos_cluster_id }}
    secret: {{ talos_cluster_secret }}
    controlPlane:
        endpoint: {{ talos_cluster_endpoint }}
    clusterName: {{ talos_cluster_name }}
    network:
        dnsDomain: {{ talos_cluster_name }}
        podSubnets:
            - 10.244.0.0/16
        serviceSubnets:
            - 10.96.0.0/12
        cni:
          name: none

    token: {{ talos_bootstrap_token }}
    secretboxEncryptionSecret: {{ talos_secretbox_secret }}
    ca:
        crt: {{ talos_cluster_ca_crt }}

    discovery:
        enabled: true
        registries:
            kubernetes:
                disabled: true
            service: {}
